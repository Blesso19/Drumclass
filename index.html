<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Drum 5‚ÄëLine Notation Maker ‚Äî Pro (Fixed)</title>
<style>
:root{--bg:#0b1020;--card:#0f1724;--muted:#9aa4bf;--accent:#7ce3ff;--accent2:#8ef78e}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
body{background:linear-gradient(180deg,#061024 0%, #071827 50%, #071826 100%);color:#e6eef8;padding:16px}
.container{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:420px 1fr;gap:16px}
.card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border:1px solid rgba(255,255,255,.05);border-radius:14px;padding:14px;box-shadow:0 6px 30px rgba(2,6,23,.6)}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#6f7eff);display:flex;align-items:center;justify-content:center;font-weight:800;color:#041025}
.title{font-size:16px;font-weight:800}
.subtitle{font-size:12px;color:var(--muted)}
.btn{background:transparent;border:1px solid rgba(255,255,255,.08);padding:8px 10px;border-radius:10px;color:#c6d3f0;cursor:pointer;font-weight:600}
.btn:hover{border-color:rgba(124,227,255,.4);color:var(--accent)}
.btn.play{background:linear-gradient(90deg,var(--accent),#6f7eff);color:#041025;border:none}
.small{font-size:12px;padding:6px 8px}
.section-title{font-size:13px;color:var(--muted);margin:10px 0 6px}
.instrument{display:flex;align-items:center;gap:8px;padding:6px;border-radius:8px;background:rgba(255,255,255,.02)}
.input{background:transparent;border:1px solid rgba(255,255,255,.08);padding:6px 8px;border-radius:8px;color:inherit}
.staff{border:1px solid rgba(255,255,255,.05);border-radius:12px;padding:10px;background:linear-gradient(180deg,#071027,#071824)}
.canvas{width:100%;height:400px;display:block;border-radius:10px}
.palette{display:flex;flex-wrap:wrap;gap:6px}
.badge{background:#101a33;padding:6px 10px;border-radius:999px;font-size:12px;color:#a8b4da}
.footer{display:flex;justify-content:space-between;margin-top:8px;color:var(--muted);font-size:12px}
@media(max-width:980px){.container{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="container">

<!-- LEFT PANEL -->
<div class="card">
  <div class="header">
    <div class="brand">
      <div class="logo">5L</div>
      <div>
        <div class="title">Drum 5‚ÄëLine Notation Maker</div>
        <div class="subtitle">Symbols ‚Ä¢ Click ‚Ä¢ Playback (FIXED)</div>
      </div>
    </div>
    <button class="btn play" id="playBtn">Play</button>
  </div>

  <div class="section-title">Note Symbols</div>
  <div class="palette" id="symbolPalette">
    <button class="btn small" data-symbol="note">‚óè</button>
    <button class="btn small" data-symbol="x">√ó</button>
    <button class="btn small" data-symbol="ghost">‚ó¶</button>
    <button class="btn small" data-symbol="accent">‚ñ∂</button>
    <button class="btn small" data-symbol="flam">ùÜì</button>
    <button class="btn small" data-symbol="roll">///</button>
    <span class="badge">Selected: <b id="activeSymbol">‚óè</b></span>
  </div>

  <div class="section-title">Settings</div>
  <div style="display:flex;gap:10px;align-items:center">
    Tempo
    <input id="tempo" class="input" type="number" value="100" min="40" max="240" style="width:80px">
  </div>

  <div style="display:flex;gap:8px;margin-top:10px">
    <button class="btn small" id="addBar">+ Bar</button>
    <button class="btn small" id="clear">Clear</button>
    <button class="btn small" id="undo">Undo</button>
    <button class="btn small" id="redo">Redo</button>
  </div>
</div>

<!-- RIGHT PANEL -->
<div class="card">
  <div class="staff">
    <canvas id="canvas" class="canvas"></canvas>
  </div>
  <div class="footer">
    <div id="info">Bars: 1 | Notes: 0</div>
    <div>Click staff to place notes</div>
  </div>
</div>
</div>

<script>
/**********************
 STATE
**********************/
const state = {
  activeSymbol:'note',
  tempo:100,
  bars:1,
  beatsPerBar:4,
  subdivisions:4,
  instruments:[
    {id:'hihat',line:0},
    {id:'snare',line:1},
    {id:'kick',line:3}
  ],
  notes:[],
  undo:[],
  redo:[]
};

/**********************
 CANVAS SETUP
**********************/
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');
function resize(){
  canvas.width=canvas.clientWidth*devicePixelRatio;
  canvas.height=canvas.clientHeight*devicePixelRatio;
  ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
  draw();
}
window.addEventListener('resize',resize);
resize();

/**********************
 DRAW STAFF
**********************/
function draw(){
  const w=canvas.width/devicePixelRatio;
  const h=canvas.height/devicePixelRatio;
  ctx.clearRect(0,0,w,h);

  const left=40, right=w-20;
  const top=60;
  const gap=26;

  ctx.strokeStyle='rgba(255,255,255,.2)';
  for(let i=0;i<5;i++){
    ctx.beginPath();
    ctx.moveTo(left,top+i*gap);
    ctx.lineTo(right,top+i*gap);
    ctx.stroke();
  }

  const totalSlots=state.bars*state.beatsPerBar*state.subdivisions;
  const slotW=(right-left)/totalSlots;

  ctx.strokeStyle='rgba(255,255,255,.08)';
  for(let i=0;i<=totalSlots;i++){
    const x=left+i*slotW;
    ctx.beginPath();ctx.moveTo(x,top-10);ctx.lineTo(x,top+gap*4+10);ctx.stroke();
  }

  state.notes.forEach(n=>{
    const inst=state.instruments.find(i=>i.id===n.instrumentId);
    if(!inst) return;
    const x=left+(n.index*slotW)+slotW/2;
    const y=top+inst.line*gap;
    drawSymbol(x,y,n.symbol);
  });

  document.getElementById('info').textContent=`Bars: ${state.bars} | Notes: ${state.notes.length}`;
}

function drawSymbol(x,y,sym){
  ctx.save();
  ctx.fillStyle='#7ce3ff';
  ctx.font='16px system-ui';
  ctx.textAlign='center';
  ctx.textBaseline='middle';
  let s='‚óè';
  if(sym==='x') s='√ó';
  if(sym==='ghost') s='‚ó¶';
  if(sym==='accent') s='‚ñ∂';
  if(sym==='flam') s='ùÜì';
  if(sym==='roll') s='///';
  ctx.fillText(s,x,y);
  ctx.restore();
}

/**********************
 NOTE PLACEMENT (‚úÖ FIXED)
**********************/
canvas.addEventListener('click',e=>{
  const rect=canvas.getBoundingClientRect();
  const x=e.clientX-rect.left;
  const y=e.clientY-rect.top;

  const left=40, right=canvas.clientWidth-20;
  const top=60, gap=26;
  const totalSlots=state.bars*state.beatsPerBar*state.subdivisions;
  const slotW=(right-left)/totalSlots;
  if(x<left||x>right) return;

  const index=Math.floor((x-left)/slotW);
  let nearest=null, best=999;
  state.instruments.forEach(i=>{
    const yy=top+i.line*gap;
    const d=Math.abs(yy-y);
    if(d<best){best=d;nearest=i;}
  });
  toggle(index,nearest.id);
});

function toggle(index,instrumentId){
  saveUndo();
  const n=state.notes.find(n=>n.index===index&&n.instrumentId===instrumentId);
  if(n){
    n.symbol=state.activeSymbol;
  }else{
    state.notes.push({index,instrumentId,symbol:state.activeSymbol});
  }
  draw();
}

/**********************
 UNDO / REDO
**********************/
function saveUndo(){
  state.undo.push(JSON.stringify(state.notes));
  state.redo.length=0;
}
function undo(){
  if(!state.undo.length) return;
  state.redo.push(JSON.stringify(state.notes));
  state.notes=JSON.parse(state.undo.pop());
  draw();
}
function redo(){
  if(!state.redo.length) return;
  state.undo.push(JSON.stringify(state.notes));
  state.notes=JSON.parse(state.redo.pop());
  draw();
}

/**********************
 AUDIO (simple)
**********************/
const audio=new (window.AudioContext||window.webkitAudioContext)();
function play(){
  audio.resume();
  const spb=60/state.tempo;
  state.notes.forEach(n=>{
    const t=audio.currentTime+n.index*(spb/state.subdivisions);
    const o=audio.createOscillator();
    const g=audio.createGain();
    o.frequency.value=200;
    g.gain.setValueAtTime(0.8,t);
    g.gain.exponentialRampToValueAtTime(0.001,t+.2);
    o.connect(g);g.connect(audio.destination);
    o.start(t);o.stop(t+.21);
  });
}

/**********************
 UI EVENTS
**********************/
document.getElementById('symbolPalette').querySelectorAll('button').forEach(b=>{
  b.onclick=()=>{
    state.activeSymbol=b.dataset.symbol;
    document.getElementById('activeSymbol').textContent=b.textContent;
  };
});
document.getElementById('tempo').onchange=e=>state.tempo=e.target.value;
document.getElementById('addBar').onclick=()=>{state.bars++;draw();};
document.getElementById('clear').onclick=()=>{saveUndo();state.notes=[];draw();};
document.getElementById('undo').onclick=undo;
document.getElementById('redo').onclick=redo;
document.getElementById('playBtn').onclick=play;
</script>
</body>
</html>