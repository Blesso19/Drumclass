<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Drums Jam ‚Äî Responsive Mobile</title>
<style>
:root{--bg:#000;--glass-start:rgba(255,255,255,0.04);--glass-end:rgba(255,255,255,0.02);--accent:#7ef9ff;--accent2:#9b59ff;--muted:#9aa0a6;--white:#fff}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--white);-webkit-font-smoothing:antialiased}
/* Lobby centered glass card */
.lobby-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
.glass-card{width:920px;max-width:96vw;border-radius:14px;padding:24px;display:grid;grid-template-columns:1fr 340px;gap:18px;background:linear-gradient(145deg,var(--glass-start),var(--glass-end));border:1px solid rgba(255,255,255,0.06);backdrop-filter:blur(14px);box-shadow:0 24px 60px rgba(0,0,0,0.7)}
.card-left{display:flex;flex-direction:column;gap:12px}
.brand{display:flex;align-items:center;gap:12px}
.brand-icon{width:56px;height:56px;border-radius:10px;background:linear-gradient(90deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:800;color:#021}
.title{font-size:20px;font-weight:800;margin:0}
.subtitle{font-size:13px;color:var(--muted)}
.controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.btn{appearance:none;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--white);padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:700}
.btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#021;border:none}
.input{flex:1;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02);color:var(--white)}
.card-right{display:flex;flex-direction:column;gap:12px}
.preview{height:160px;border-radius:8px;background:linear-gradient(90deg,rgba(126,249,255,0.02),rgba(155,89,255,0.01));display:flex;align-items:center;justify-content:center;color:var(--muted);border:1px solid rgba(255,255,255,0.03)}
.small{font-size:13px;color:var(--muted)}
/* App */
.app-wrap{display:none;padding:18px;min-height:100vh}
.container{max-width:1200px;margin:0 auto}
.main-grid{display:grid;grid-template-columns:1fr 360px;gap:12px}
@media(max-width:980px){.main-grid{grid-template-columns:1fr}.glass-card{grid-template-columns:1fr}}
.panel{background:rgba(255,255,255,0.02);padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
/* Sequencer area */
.sequencer{display:flex;flex-direction:column;gap:8px}
.controls-bar{display:flex;align-items:center;gap:8px;justify-content:center}
.controls-bar .btn{padding:8px 10px}
.controls-bar .tempo{display:flex;align-items:center;gap:8px}
.grid-wrap{overflow:hidden;border-radius:8px}
.track-row{display:flex;align-items:center;gap:8px;padding:6px}
.track-label{width:96px;color:var(--muted);font-weight:700}
.pads-scroll{overflow-x:auto;overflow-y:hidden;white-space:nowrap;padding-bottom:6px; -webkit-overflow-scrolling:touch}
.pad{display:inline-flex;align-items:center;justify-content:center;width:56px;height:56px;margin-right:8px;border-radius:8px;background:rgba(255,255,255,0.03);cursor:pointer;user-select:none}
.pad.active{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#021;box-shadow:0 8px 20px rgba(0,0,0,0.35)}
@media(max-width:900px){.pad{width:48px;height:48px;margin-right:6px}.track-label{width:72px}}
@media(max-width:520px){.pad{width:40px;height:40px;margin-right:6px}.track-label{width:64px}}
.notation{height:160px;border-radius:8px;overflow:hidden;margin-top:6px}
canvas{width:100%;height:100%;display:block}
/* bottom nav for mobile */
.bottom-nav{position:fixed;left:12px;right:12px;bottom:12px;border-radius:14px;padding:8px;display:flex;justify-content:space-around;align-items:center;border:1px solid rgba(255,255,255,0.03);z-index:60;background:linear-gradient(90deg,#6a11cb,#2575fc);box-shadow:0 12px 30px rgba(37,117,252,0.18)}
.footer{padding:18px;text-align:center;color:var(--muted)}
  /* Soft Scale Pad Animation */
  .step {
    transition: transform 0.15s ease, box-shadow 0.15s ease;
  }
  .step.active {
    transform: scale(1.15);
    box-shadow: 0 0 10px rgba(255,255,255,0.4);
    border-color: #fff;
  }
</style>
</head>
<body>
<!-- Hidden uploaded image path (not displayed) -->
<img src="/mnt/data/1000128380.jpg" class="hidden" style="display:none" alt="logo">

<!-- Lobby: glass card centered -->
<div class="lobby-screen" id="lobbyScreen">
  <div class="glass-card" role="dialog">
    <div class="card-left">
      <div class="brand">
        <div class="brand-icon">DJ</div>
        <div>
          <div class="title">Drums Jam</div>
          <div class="subtitle">Create or join a studio session ‚Äî pure black studio UI</div>
        </div>
      </div>

      <div>
        <div class="small">Create session</div>
        <div class="controls" style="margin-top:8px">
          <button id="createBtn" class="btn primary">Create Session</button>
          <button id="createDemoBtn" class="btn">Local Demo</button>
        </div>
      </div>

      <div>
        <div class="small" style="margin-top:12px">Join session</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="joinInput" class="input" placeholder="Paste meeting link or MEET-XXXX" />
          <button id="joinBtn" class="btn">Join</button>
        </div>
      </div>

      <div class="small" style="margin-top:12px;color:var(--muted)">Online features use Supabase ‚Äî paste your keys in the config section.</div>
    </div>

    <div class="card-right">
      <div class="small">Preview</div>
      <div class="preview">Studio Preview</div>
      <div style="margin-top:8px" class="small">Local sessions</div>
      <div id="localSessions" class="small" style="color:var(--muted)">None</div>
    </div>
  </div>
</div>

<!-- App area -->
<div class="app-wrap" id="appWrap">
  <div class="container">
    <div class="main-grid">
      <div>
        <div class="panel sequencer">
          <div class="controls-bar">
            <button id="playBtn" class="btn primary">Play</button>
            <button id="stopBtn" class="btn">Stop</button>
            <div class="tempo">
              <input id="tempo" type="range" min="40" max="220" value="120" />
              <span id="tempoLabel" class="small" style="margin-left:8px">120 BPM</span>
            </div>
          </div>

          <div id="tracks" style="margin-top:12px">
            <!-- tracks will be injected here -->
          </div>

          <div class="notation panel">
            <canvas id="notationCanvas"></canvas>
          </div>
        </div>
      </div>

      <aside>
        <div class="panel">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Recording</strong><div class="small" style="color:var(--muted)">Local audio</div></div>
            <div><button id="recordBtn" class="btn">Record</button></div>
          </div>
          <div id="recordings" style="margin-top:8px"></div>
        </div>

        <div class="panel">
          <div style="font-weight:700">Session Link</div>
          <div id="sessionLink" class="small" style="margin-top:6px;color:var(--muted)">‚Äî</div>
          <div style="margin-top:8px"><button id="copyBtn" class="btn">Copy Link</button></div>
        </div>

        <div class="panel">
          <div style="font-weight:700">Participants</div>
          <div id="presenceList" class="small" style="margin-top:8px;color:var(--muted)">‚Äî</div>
          <div style="margin-top:8px"><button id="startCallBtn" class="btn">Start Call</button><button id="endCallBtn" class="btn" style="margin-left:8px">End Call</button></div>
        </div>
      </aside>
    </div>
  </div>
</div>

<div class="bottom-nav" id="bottomNav" style="display:none">
  <div class="bn-item">üéß<div style="font-size:11px">Jam</div></div>
  <div class="bn-item">üé•<div style="font-size:11px">Video</div></div>
  <div class="bn-item">üí¨<div style="font-size:11px">Chat</div></div>
  <div class="bn-item">üë•<div style="font-size:11px">People</div></div>
</div>

<div class="footer">Pure black studio ‚Ä¢ responsive drum machine</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
<script>
/* CONFIG */
const SUPABASE_URL = 'https://YOUR_SUPABASE_URL.supabase.co';
const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
const APP_ORIGIN = window.location.origin;
let supabase = null;
if(!SUPABASE_URL.includes('YOUR_SUPABASE') && window.supabase && typeof window.supabase.createClient === 'function') supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* DOM */
const lobbyScreen = document.getElementById('lobbyScreen');
const appWrap = document.getElementById('appWrap');
const createBtn = document.getElementById('createBtn');
const createDemoBtn = document.getElementById('createDemoBtn');
const joinInput = document.getElementById('joinInput');
const joinBtn = document.getElementById('joinBtn');
const localSessions = document.getElementById('localSessions');
const sessionLink = document.getElementById('sessionLink');
const presenceList = document.getElementById('presenceList');
const tracksEl = document.getElementById('tracks');
const notationCanvas = document.getElementById('notationCanvas');
const playBtn = document.getElementById('playBtn');
const stopBtn = document.getElementById('stopBtn');
const tempoCtrl = document.getElementById('tempo');
const tempoLabel = document.getElementById('tempoLabel');
const recordBtn = document.getElementById('recordBtn');
const recordings = document.getElementById('recordings');
const copyBtn = document.getElementById('copyBtn');
const startCallBtn = document.getElementById('startCallBtn');
const endCallBtn = document.getElementById('endCallBtn');
const bottomNav = document.getElementById('bottomNav');

/* State */
const INSTR = [ {id:'kick',label:'Kick'}, {id:'snare',label:'Snare'}, {id:'hihat',label:'Hi-Hat'}, {id:'tom1',label:'Tom 1'}, {id:'tom2',label:'Tom 2'}, {id:'floor',label:'Floor Tom'} ];
let STEPS = 64; let seq = {};
INSTR.forEach(i=>seq[i.id]=new Array(STEPS).fill(false));
let currentSession = null; let isLocal = false; let userId = 'u-'+Math.random().toString(36).slice(2,8);

/* Helpers */
function makeId(){ return 'MEET-'+Math.random().toString(36).slice(2,8).toUpperCase(); }
function showApp(){ lobbyScreen.style.display='none'; appWrap.style.display='block'; if(window.innerWidth<=720) bottomNav.style.display='flex'; }

/* Build tracks with horizontal scroll */
function buildTracks(){ tracksEl.innerHTML=''; INSTR.forEach(inst=>{
  const row = document.createElement('div'); row.className='track-row';
  const label = document.createElement('div'); label.className='track-label'; label.textContent = inst.label; row.appendChild(label);
  const sc = document.createElement('div'); sc.className='pads-scroll'; sc.setAttribute('role','list');
  for(let i=0;i<STEPS;i++){ const p = document.createElement('div'); p.className='pad ' + (seq[inst.id][i] ? 'active':'ghost'); p.dataset.inst = inst.id; p.dataset.i = i; p.innerHTML = seq[inst.id][i] ? '‚óè' : ''; p.addEventListener('click', ()=>{ seq[inst.id][i] = !seq[inst.id][i]; p.classList.toggle('active', seq[inst.id][i]); p.classList.toggle('ghost', !seq[inst.id][i]); p.innerHTML = seq[inst.id][i] ? '‚óè' : ''; renderNotation(); pushState(); if(pcData && pcData.readyState==='open') pcData.send(JSON.stringify({type:'step',inst:inst.id,i:i,val:seq[inst.id][i]})); }); sc.appendChild(p); }
  row.appendChild(sc); tracksEl.appendChild(row);
}); }

/* Notation canvas */
const canvas = notationCanvas; const ctx = canvas.getContext('2d');
function resize(){ canvas.width = canvas.clientWidth * devicePixelRatio; canvas.height = canvas.clientHeight * devicePixelRatio; ctx.setTransform(1,0,0,1,0,0); ctx.scale(devicePixelRatio,devicePixelRatio); drawStaff(); }
window.addEventListener('resize', resize); window.addEventListener('load', resize);
function drawStaff(){ const w = canvas.clientWidth, h = canvas.clientHeight; ctx.clearRect(0,0,w,h); ctx.strokeStyle='#444'; ctx.lineWidth=1; const margin=12, usable=h-margin*2, spacing=usable/6; for(let i=0;i<5;i++){ const y=margin+spacing*(i+1); ctx.beginPath(); ctx.moveTo(10,y); ctx.lineTo(w-10,y); ctx.stroke(); } renderNotation(); }
function renderNotation(playhead=-1){ const w=canvas.clientWidth, h=canvas.clientHeight; ctx.clearRect(0,0,w,h); drawLinesOnly(); const left=18, right=w-18, stepW=(right-left)/STEPS; const margin=12, slot=(h-margin*2)/6; const lines=[]; for(let i=1;i<=5;i++) lines.push(margin+slot*i); const spaces=[]; for(let i=0;i<4;i++) spaces.push((lines[i]+lines[i+1])/2); const pos={ kick:spaces[0], floor:spaces[1], snare:spaces[2], tom1:spaces[3], tom2:lines[3], hihat:lines[4] };
  INSTR.forEach(inst=>{ for(let i=0;i<STEPS;i++){ const x=left+i*stepW+stepW/2; const y=pos[inst.id]; ctx.beginPath(); ctx.fillStyle='rgba(255,255,255,0.03)'; ctx.arc(x,y,4,0,Math.PI*2); ctx.fill(); } });
  INSTR.forEach(inst=>{ for(let i=0;i<STEPS;i++){ if(seq[inst.id][i]){ const x=left+i*stepW+stepW/2; const y=pos[inst.id]; if(inst.id==='hihat'){ ctx.beginPath(); ctx.strokeStyle='#81d4fa'; ctx.lineWidth=2; ctx.moveTo(x-5,y-5); ctx.lineTo(x+5,y+5); ctx.moveTo(x-5,y+5); ctx.lineTo(x+5,y-5); ctx.stroke(); } else { ctx.beginPath(); ctx.fillStyle=(inst.id==='kick'?'#ff8a80':inst.id==='snare'?'#ffd54f':'#ffd180'); ctx.ellipse(x,y,5,3.5,0,0,Math.PI*2); ctx.fill(); if(['snare','tom1','tom2','floor'].includes(inst.id)){ ctx.beginPath(); ctx.strokeStyle='#ffd54f'; ctx.lineWidth=2; ctx.moveTo(x+4,y); ctx.lineTo(x+4,y-18); ctx.stroke(); } } } } });
  if(playhead>=0){ ctx.beginPath(); ctx.fillStyle='rgba(255,255,255,0.04)'; ctx.fillRect(left+playhead*stepW,6,stepW,h-12); } }
function drawLinesOnly(){ const w=canvas.clientWidth, h=canvas.clientHeight; ctx.save(); ctx.strokeStyle='#444'; ctx.lineWidth=1; const margin=12, usable=h-margin*2, spacing=usable/6; for(let i=0;i<5;i++){ const y=margin+spacing*(i+1); ctx.beginPath(); ctx.moveTo(10,y); ctx.lineTo(w-10,y); ctx.stroke(); } ctx.restore(); }

/* Audio */
const AudioContext = window.AudioContext || window.webkitAudioContext; const audioCtx = new AudioContext(); const master = audioCtx.createGain(); master.gain.value=0.9; master.connect(audioCtx.destination);
function kick(t){ const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type='sine'; o.frequency.setValueAtTime(120,t); o.frequency.exponentialRampToValueAtTime(45,t+0.18); g.gain.setValueAtTime(1,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.35); o.connect(g); g.connect(master); o.start(t); o.stop(t+0.35); }
function snare(t){ const buf=audioCtx.createBuffer(1,audioCtx.sampleRate*0.18,audioCtx.sampleRate); const d=buf.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*Math.exp(-i/d.length*6); const src=audioCtx.createBufferSource(); src.buffer=buf; const f=audioCtx.createBiquadFilter(); f.type='bandpass'; f.frequency.value=2200; const g=audioCtx.createGain(); g.gain.setValueAtTime(1,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.18); src.connect(f); f.connect(g); g.connect(master); src.start(t); src.stop(t+0.18); }
function hihat(t){ const buf=audioCtx.createBuffer(1,audioCtx.sampleRate*0.06,audioCtx.sampleRate); const d=buf.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*Math.exp(-i/d.length*10); const src=audioCtx.createBufferSource(); src.buffer=buf; const f=audioCtx.createBiquadFilter(); f.type='highpass'; f.frequency.value=6000; const g=audioCtx.createGain(); g.gain.setValueAtTime(0.6,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.06); src.connect(f); f.connect(g); g.connect(master); src.start(t); src.stop(t+0.08); }
function tom(t,p){ const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type='sine'; o.frequency.setValueAtTime(p,t); o.frequency.exponentialRampToValueAtTime(p*0.7,t+0.18); g.gain.setValueAtTime(0.9,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.35); o.connect(g); g.connect(master); o.start(t); o.stop(t+0.35); }

/* Transport */
let playing=false, playIndex=0, schedId=null;
function schedule(){ const bpm=parseInt(tempoCtrl.value); const ms=(60/bpm)/4*1000; const t=audioCtx.currentTime; INSTR.forEach(inst=>{ if(seq[inst.id][playIndex]){ if(inst.id==='kick') kick(t); if(inst.id==='snare') snare(t); if(inst.id==='hihat') hihat(t); if(inst.id==='tom1') tom(t,520); if(inst.id==='tom2') tom(t,380); if(inst.id==='floor') tom(t,260); } }); renderNotation(playIndex); playIndex=(playIndex+1)%STEPS; schedId=setTimeout(schedule,ms); }
playBtn.addEventListener('click', ()=>{ if(playing) return; playing=true; playIndex=0; schedule(); });
stopBtn.addEventListener('click', ()=>{ if(!playing) return; playing=false; clearTimeout(schedId); renderNotation(-1); });
tempoCtrl.addEventListener('input', ()=>{ tempoLabel.textContent = tempoCtrl.value + ' BPM'; });

/* Save/Load local */
const saveBtn = document.getElementById('saveBtn'); const loadBtn = document.getElementById('loadBtn');
saveBtn.addEventListener('click', ()=>{ const name = prompt('Pattern name','pattern1'); if(!name) return; const store = JSON.parse(localStorage.getItem('dj_patterns')||'{}'); store[name] = JSON.stringify(seq); localStorage.setItem('dj_patterns',JSON.stringify(store)); alert('Saved: '+name); });
loadBtn.addEventListener('click', ()=>{ const store = JSON.parse(localStorage.getItem('dj_patterns')||'{}'); const keys = Object.keys(store); if(!keys.length) return alert('No patterns'); const name = prompt('Load pattern name. Available: '+keys.join(', '), keys[0]); if(!name || !store[name]) return alert('Not found'); seq = JSON.parse(store[name]); buildTracks(); renderNotation(); pushState(); alert('Loaded: '+name); });

/* Persistence & realtime (Supabase) */
async function pushState(){ if(!currentSession) return; const payload = { session_id: currentSession.id, state: JSON.stringify(seq) }; if(supabase){ try{ await supabase.from('sequencer_state').upsert(payload); }catch(e){ console.warn(e); } } else { window._localSessions = window._localSessions || {}; if(currentSession) window._localSessions[currentSession.id] = { state: JSON.stringify(seq), created_at: new Date().toISOString() }; localSessions.textContent = currentSession.id; } }
function applyRemote(state){ INSTR.forEach(i=>{ if(state[i.id] && Array.isArray(state[i.id])) seq[i.id] = state[i.id].slice(0,STEPS); }); buildTracks(); renderNotation(); }
let seqSub = null; function subscribeSequencer(id){ if(!supabase) return; try{ if(seqSub && seqSub.unsubscribe) seqSub.unsubscribe(); }catch(e){} seqSub = supabase.channel('seq-'+id).on('postgres_changes',{event:'*',schema:'public',table:'sequencer_state',filter:`session_id=eq.${id}`}, payload=>{ try{ const row = payload.new || payload.record; if(row && row.state) applyRemote(JSON.parse(row.state)); }catch(e){console.warn(e);} }).subscribe(); }

/* Chat */
async function sendChat(msg){ if(!currentSession) return; const payload = { session_id: currentSession.id, user: userId, message: msg }; if(supabase){ try{ await supabase.from('chat_messages').insert(payload); }catch(e){console.warn(e);} } else { /* local echo */ } }
function addChat(user,msg){ const el = document.createElement('div'); el.className='small'; el.textContent = user+': '+msg; recordings.prepend(el); }
let chatSub = null; function subscribeChat(id){ if(!supabase) return; try{ if(chatSub && chatSub.unsubscribe) chatSub.unsubscribe(); }catch(e){} chatSub = supabase.channel('chat-'+id).on('postgres_changes',{event:'INSERT',schema:'public',table:'chat_messages',filter:`session_id=eq.${id}`}, payload=>{ try{ const row = payload.new || payload.record; if(row) addChat(row.user,row.message); }catch(e){console.warn(e);} }).subscribe(); }

/* Presence */
async function setPresence(){ if(!currentSession || !supabase) return; try{ await supabase.from('presence').upsert({session_id:currentSession.id,user:userId,last_seen:new Date().toISOString()}); }catch(e){console.warn(e);} }
let presSub=null; function subscribePresence(id){ if(!supabase) return; try{ if(presSub && presSub.unsubscribe) presSub.unsubscribe(); }catch(e){} presSub = supabase.channel('pres-'+id).on('postgres_changes',{event:'*',schema:'public',table:'presence',filter:`session_id=eq.${id}`}, payload=>{ (async()=>{ try{ const { data } = await supabase.from('presence').select('user').eq('session_id',id); if(data) presenceList.textContent = data.map(x=>x.user).join(', '); }catch(e){console.warn(e);} })(); }).subscribe(); }

/* WebRTC signaling */
let pc=null, pcData=null, localStream=null;
async function getLocalMedia(){ try{ localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true}); const lv = document.getElementById('localVideo'); if(lv) lv.srcObject = localStream; }catch(e){console.warn('getUserMedia',e);} }
getLocalMedia();
function setupPC(){ pc = new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]}); pc.ontrack = ev=>{ const rv=document.getElementById('remoteVideo'); if(rv) rv.srcObject = ev.streams[0]; }; pc.ondatachannel = ev=>{ pcData = ev.channel; pcData.onmessage = e=>{ try{ const d=JSON.parse(e.data); if(d.type==='step'){ seq[d.inst][d.i]=d.val; buildTracks(); renderNotation(); } }catch(err){console.warn(err);} }; }; pc.onicecandidate = async e=>{ if(e.candidate && supabase) await supabase.from('webrtc_signaling').insert({session_id:currentSession.id,kind:'ice',payload:e.candidate.toJSON()}); }; if(localStream) localStream.getTracks().forEach(t=>pc.addTrack(t,localStream)); }
async function startCall(){ if(!currentSession || !supabase) return alert('Signaling needs Supabase'); setupPC(); pcData = pc.createDataChannel('seq'); pcData.onmessage = e=>{ try{ const d=JSON.parse(e.data); if(d.type==='step'){ seq[d.inst][d.i]=d.val; buildTracks(); renderNotation(); } }catch(err){console.warn(err);} }; const offer = await pc.createOffer(); await pc.setLocalDescription(offer); await supabase.from('webrtc_signaling').insert({session_id:currentSession.id,kind:'offer',payload:offer}); subscribeSignaling(currentSession.id); }
async function subscribeSignaling(id){ if(!supabase) return; supabase.channel('webrtc-'+id).on('postgres_changes',{event:'*',schema:'public',table:'webrtc_signaling',filter:`session_id=eq.${id}`}, async payload=>{ try{ const row = payload.new || payload.record; if(!row) return; if(row.kind==='offer'){ if(pc) return; setupPC(); await pc.setRemoteDescription(row.payload); const answer = await pc.createAnswer(); await pc.setLocalDescription(answer); await supabase.from('webrtc_signaling').insert({session_id:id,kind:'answer',payload:answer}); } else if(row.kind==='answer' && pc && !pc.currentRemoteDescription){ await pc.setRemoteDescription(row.payload); } else if(row.kind==='ice' && pc){ try{ await pc.addIceCandidate(row.payload); }catch(e){console.warn(e);} } }catch(e){console.warn(e);} }).subscribe(); }
async function endCall(){ if(pc){ pc.close(); pc=null; } pcData=null; }

/* Create / Join flow */
async function createSession(){ const id = makeId(); const link = APP_ORIGIN + '/session/' + id; currentSession = {id,link}; isLocal=false; sessionLink.textContent = link; showApp(); if(supabase){ try{ await supabase.from('sessions').upsert({session_id:id,created_at:new Date().toISOString()}); await supabase.from('sequencer_state').upsert({session_id:id,state:JSON.stringify(seq)}); subscribeSequencer(id); subscribeChat(id); subscribePresence(id); setInterval(setPresence,15000); setPresence(); }catch(e){console.warn(e);} } else { window._localSessions = window._localSessions||{}; window._localSessions[id] = { state: JSON.stringify(seq), created_at: new Date().toISOString() }; isLocal=true; localSessions.textContent = id; } }
async function createDemo(){ await createSession(); isLocal=true; }
async function joinSession(){ const raw = (joinInput.value||'').trim(); if(!raw) return alert('Paste link or ID'); const id = raw.includes('/')? raw.split('/').pop(): raw; currentSession={id,link:APP_ORIGIN + '/session/' + id}; sessionLink.textContent = currentSession.link; showApp(); if(supabase){ try{ const { data } = await supabase.from('sequencer_state').select('state').eq('session_id',id).limit(1).single(); if(data && data.state) applyRemote(JSON.parse(data.state)); subscribeSequencer(id); subscribeChat(id); subscribePresence(id); setInterval(setPresence,15000); setPresence(); subscribeSignaling(id); }catch(e){console.warn(e);} } else { const s = window._localSessions && window._localSessions[id]; if(s && s.state){ applyRemote(JSON.parse(s.state)); isLocal=true; } else alert('Local demo not found'); } }
createBtn.addEventListener('click',createSession); createDemoBtn.addEventListener('click',createDemo); joinBtn.addEventListener('click',joinSession); copyBtn.addEventListener('click',()=>{ if(!currentSession) return alert('No session'); navigator.clipboard.writeText(currentSession.link).then(()=>alert('Copied')); }); startCallBtn.addEventListener('click',startCall); endCallBtn.addEventListener('click',endCall);

/* recording (local) */
let mediaRec=null, recorded=[]; recordBtn.addEventListener('click',()=>{ if(mediaRec && mediaRec.state==='recording'){ mediaRec.stop(); recordBtn.textContent='Record'; } else { const dest=audioCtx.createMediaStreamDestination(); master.connect(dest); mediaRec=new MediaRecorder(dest.stream); recorded=[]; mediaRec.ondataavailable=e=>{ if(e.data.size) recorded.push(e.data); }; mediaRec.onstop=()=>{ const blob=new Blob(recorded,{type:'audio/webm'}); const url=URL.createObjectURL(blob); const el=document.createElement('div'); const a=document.createElement('audio'); a.controls=true; a.src=url; el.appendChild(a); const d=document.createElement('a'); d.href=url; d.download='rec.webm'; d.textContent=' Download'; d.style.marginLeft='8px'; el.appendChild(d); recordings.appendChild(el); }; mediaRec.start(); recordBtn.textContent='Stop'; } });

/* bottom nav responsive show */
function refreshBottom(){ if(window.innerWidth<=720) document.getElementById('bottomNav').style.display='flex'; else document.getElementById('bottomNav').style.display='none'; }
window.addEventListener('resize',refreshBottom); refreshBottom();

/* init */
buildTracks(); resize(); renderNotation(); for(let i=0;i<STEPS;i+=4) seq.hihat[i]=true; seq.kick[0]=true; seq.kick[16]=true; seq.snare[8]=true; seq.snare[24]=true; buildTracks(); renderNotation();
</script>
</body>
</html>
