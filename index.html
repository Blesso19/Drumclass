<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Drums Jam ‚Äî Final Studio</title>
<style>
  :root{--bg:#050507;--panel:#0f1114;--accent:#7ef9ff;--accent2:#9b59ff;--muted:#9aa0a6}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter, system-ui, -apple-system, Arial, sans-serif;background:linear-gradient(180deg,#030307,#071018);color:#fff;min-height:100vh}
  header{display:flex;gap:12px;align-items:center;padding:12px 16px;background:rgba(255,255,255,0.01);border-bottom:1px solid rgba(255,255,255,0.02);position:sticky;top:0;z-index:40}
  header img{width:44px;height:44px;border-radius:8px;object-fit:cover}
  h1{font-size:18px;margin:0;color:var(--accent)}
  .small{font-size:13px;color:var(--muted)}

  /* layout */
  main{display:grid;grid-template-columns:1fr 360px;gap:12px;padding:14px}
  @media(max-width:980px){ main{grid-template-columns:1fr} }

  /* panels */
  .panel{background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.02)}

  /* sequencer grid */
  .grid-wrap{overflow:auto}
  .grid-header{display:grid;grid-template-columns:88px repeat(64,56px);gap:8px;align-items:center}
  .row{display:grid;grid-template-columns:88px repeat(64,56px);gap:8px;align-items:center}
  .label{padding-left:8px;color:var(--muted);min-width:88px}
  .pad{width:56px;height:56px;border-radius:8px;background:rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center;cursor:pointer;user-select:none}
  .pad.active{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#021;box-shadow:0 8px 24px rgba(124,234,255,0.06)}
  .pad.ghost{background:rgba(255,255,255,0.01)}
  @media(max-width:900px){ .grid-header,.row{grid-template-columns:72px repeat(32,48px)} .pad{width:48px;height:48px} }
  @media(max-width:520px){ .grid-header,.row{grid-template-columns:64px repeat(32,40px)} .pad{width:40px;height:40px;border-radius:6px} .label{min-width:64px} }

  /* notation */
  .notation{height:180px;border-radius:8px;overflow:hidden}
  canvas{width:100%;height:100%;display:block}

  /* tabs */
  .tabs{display:flex;gap:8px}
  .tab{padding:8px 12px;border-radius:8px;cursor:pointer;border:1px solid rgba(255,255,255,0.03)}
  .tab.active{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#021}

  /* bottom nav */
  .bottom-nav{position:fixed;left:12px;right:12px;bottom:12px;border-radius:14px;padding:8px;display:flex;justify-content:space-around;align-items:center;border:1px solid rgba(255,255,255,0.03);z-index:60;background:linear-gradient(90deg,#6a11cb,#2575fc);box-shadow:0 12px 30px rgba(37,117,252,0.18);backdrop-filter:blur(6px)}
  .bn-item{flex:1;text-align:center;padding:10px 12px;border-radius:10px;cursor:pointer;color:rgba(255,255,255,0.92);font-weight:700}
  .bn-item.active{background:linear-gradient(90deg,rgba(255,255,255,0.12),rgba(255,255,255,0.06));color:#021;box-shadow:0 8px 20px rgba(0,0,0,0.25)}

  footer{padding:12px;text-align:center;color:var(--muted)}
</style>
</head>
<body>
<header>
  <img src="/mnt/data/1000128380.jpg" alt="logo" />
  <div>
    <h1>Drums Jam ‚Äî Final Studio</h1>
    <div class="small">Responsive ‚Ä¢ 64-step ‚Ä¢ Supabase-ready ‚Ä¢ Tabs + Bottom Nav</div>
  </div>
</header>

<!-- Lobby (simple, centered) -->
<div id="lobby" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:80;">
  <div style="width:920px;max-width:94vw;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);padding:20px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);display:grid;grid-template-columns:1fr 340px;gap:12px;align-items:start">
    <div>
      <div style="display:flex;gap:12px;align-items:center">
        <div style="width:56px;height:56px;border-radius:8px;background:linear-gradient(90deg,var(--accent),var(--accent2);display:flex;align-items:center;justify-content:center;font-weight:700">DJ</div>
        <div>
          <div style="font-weight:700;color:var(--accent)">Drums Jam ‚Äî Dark Studio Lobby</div>
          <div class="small" style="margin-top:6px">Create a session link and invite students. Only those with the link can join.</div>
        </div>
      </div>

      <div style="margin-top:16px">
        <div class="small">Create a Session</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="lobbyCreateBtn" class="bn-item" style="flex:0 0 auto;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#021;border-radius:10px;padding:10px 16px">Create Session</button>
          <button id="lobbyDemoBtn" class="bn-item" style="flex:0 0 auto;padding:10px 16px">Create Local Demo</button>
        </div>
      </div>

      <div style="margin-top:14px">
        <div class="small">Join Session</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="lobbyInput" placeholder="Paste link or MEET-XXXX" style="flex:1;padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:#fff" />
          <button id="lobbyJoinBtn" class="bn-item" style="flex:0 0 auto;padding:10px 12px">Join</button>
        </div>
      </div>
    </div>
    <div>
      <div class="small">Preview</div>
      <div style="height:160px;border-radius:8px;background:linear-gradient(90deg,rgba(126,249,255,0.03),rgba(155,89,255,0.02));display:flex;align-items:center;justify-content:center;margin-top:8px;color:var(--muted)">Studio Preview</div>
      <div style="margin-top:12px" class="small">Saved local sessions</div>
      <div id="localSessions" class="small" style="margin-top:8px;color:var(--muted)">None</div>
    </div>
  </div>
</div>

<!-- App content -->
<main id="app" style="display:none">
  <div style="display:flex;flex-direction:column;gap:12px;padding:12px">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
      <div style="font-weight:700">Session: <span id="sessionLabel" class="small">‚Äî</span></div>
      <div class="tabs">
        <div id="tabJam" class="tab active">Jam</div>
        <div id="tabVideo" class="tab">Video</div>
        <div id="tabChat" class="tab">Chat</div>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 360px;gap:12px">
      <div>
        <div class="panel">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div><strong>Drum Sequencer</strong><div class="small">64 steps ‚Äî touch-friendly</div></div>
            <div style="display:flex;gap:8px;align-items:center">
              <button id="play" class="bn-item" style="padding:8px 12px">Play</button>
              <button id="stop" class="bn-item" style="padding:8px 12px">Stop</button>
            </div>
          </div>

          <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
            <div class="small">Tempo</div>
            <input id="tempo" type="range" min="40" max="220" value="120" />
            <div id="tempoLabel" class="small">120 BPM</div>
            <div style="flex:1"></div>
            <button id="clear" class="bn-item">Clear</button>
          </div>

          <div class="grid-wrap" style="max-width:100%;overflow:auto">
            <div id="gridHeader" class="grid-header"></div>
            <div id="gridRows"></div>
          </div>
        </div>

        <div class="panel notation" style="margin-top:10px">
          <canvas id="notation" style="width:100%;height:180px"></canvas>
        </div>
      </div>

      <aside style="display:flex;flex-direction:column;gap:12px">
        <div class="panel">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Recordings</strong><div class="small">Local only</div></div>
            <div><button id="record" class="bn-item">Record</button></div>
          </div>
          <div id="recs" style="margin-top:8px"></div>
        </div>

        <div class="panel">
          <div style="font-weight:700">Session Link</div>
          <div id="sessionLink" class="small" style="margin-top:6px;color:var(--muted)">‚Äî</div>
          <div style="margin-top:8px"><button id="copyLink" class="bn-item">Copy Link</button></div>
        </div>

        <div class="panel">
          <div style="font-weight:700">Participants</div>
          <div id="presence" class="small" style="margin-top:8px;color:var(--muted)">‚Äî</div>
        </div>
      </aside>
    </div>
  </div>
</main>

<!-- Bottom nav (mobile) -->
<div id="bottomNav" class="bottom-nav" style="display:none">
  <div class="bn-item active" data-tab="jam">üéß<div style="font-size:11px">Jam</div></div>
  <div class="bn-item" data-tab="video">üé•<div style="font-size:11px">Video</div></div>
  <div class="bn-item" data-tab="chat">üí¨<div style="font-size:11px">Chat</div></div>
  <div class="bn-item" data-tab="people">üë•<div style="font-size:11px">People</div></div>
</div>

<footer>Finalized ‚Äî responsive & cleaned. Replace Supabase keys to enable realtime features.</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
<script>
// CONFIG: paste your Supabase project details here to enable realtime + signaling
const SUPABASE_URL = 'https://YOUR_SUPABASE_URL.supabase.co';
const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
const APP_ORIGIN = window.location.origin;
let supabase = null;
if(!SUPABASE_URL.includes('YOUR_SUPABASE') && window.supabase && typeof window.supabase.createClient === 'function'){
  supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
}

/* Minimal, clean final JS wiring */
const lobby = document.getElementById('lobby');
const app = document.getElementById('app');
const lobbyCreateBtn = document.getElementById('lobbyCreateBtn');
const lobbyDemoBtn = document.getElementById('lobbyDemoBtn');
const lobbyInput = document.getElementById('lobbyInput');
const lobbyJoinBtn = document.getElementById('lobbyJoinBtn');
const localSessions = document.getElementById('localSessions');
const sessionLabel = document.getElementById('sessionLabel');
const sessionLink = document.getElementById('sessionLink');
const presence = document.getElementById('presence');
const gridHeader = document.getElementById('gridHeader');
const gridRows = document.getElementById('gridRows');
const notation = document.getElementById('notation');
const tempo = document.getElementById('tempo');
const tempoLabel = document.getElementById('tempoLabel');
const playBtn = document.getElementById('play');
const stopBtn = document.getElementById('stop');
const clearBtn = document.getElementById('clear');
const copyBtn = document.getElementById('copyLink');
const recordBtn = document.getElementById('record');

const tabs = { jam: document.getElementById('tabJam'), video: document.getElementById('tabVideo'), chat: document.getElementById('tabChat') };
const bottomNav = document.getElementById('bottomNav');

let currentSession = null; let isLocalDemo = false;

/* instruments & state */
const INSTR = [
  {id:'kick', label:'Kick'},
  {id:'snare', label:'Snare'},
  {id:'hihat', label:'Hi-Hat'},
  {id:'tom1', label:'Tom 1'},
  {id:'tom2', label:'Tom 2'},
  {id:'floor', label:'Floor Tom'}
];
let STEPS = 64; let seq = {};
INSTR.forEach(i=>seq[i.id]=new Array(STEPS).fill(false));

function makeId(){ return 'MEET-'+Math.random().toString(36).slice(2,8).toUpperCase(); }

async function createSession(){ const id=makeId(); const link = APP_ORIGIN + '/session/' + id; currentSession={id,link}; isLocalDemo=false; sessionLabel.textContent=id; sessionLink.textContent=link; lobby.style.display='none'; app.style.display='block'; if(supabase){ try{ await supabase.from('sessions').upsert({session_id:id,created_at:new Date().toISOString()}); await supabase.from('sequencer_state').upsert({session_id:id,state:JSON.stringify(seq)}); subscribeToSession(id); }catch(e){console.warn(e);} } else { window._localSessions=window._localSessions||{}; window._localSessions[id]={state:JSON.stringify(seq),created_at:new Date().toISOString()}; isLocalDemo=true; localSessions.textContent = id; } }
async function joinSession(){ const raw = (lobbyInput.value||'').trim(); if(!raw) return alert('Paste link or ID'); const id = raw.includes('/')? raw.split('/').pop(): raw; currentSession={id,link:APP_ORIGIN + '/session/' + id}; sessionLabel.textContent=id; sessionLink.textContent=currentSession.link; lobby.style.display='none'; app.style.display='block'; if(supabase){ try{ const {data,error} = await supabase.from('sequencer_state').select('state').eq('session_id',id).limit(1).single(); if(data && data.state) applyState(JSON.parse(data.state)); subscribeToSession(id); }catch(e){console.warn(e);} } else { const s = window._localSessions && window._localSessions[id]; if(s && s.state){ applyState(JSON.parse(s.state)); isLocalDemo=true; } else { alert('Local session not found ‚Äî create demo first'); } } }

lobbyCreateBtn.addEventListener('click',createSession); lobbyDemoBtn.addEventListener('click',async()=>{ await createSession(); isLocalDemo=true; }); lobbyJoinBtn.addEventListener('click',joinSession);

/* build grid UI */
function buildGrid(){ gridHeader.innerHTML=''; const hr=document.createElement('div'); hr.className='grid-header'; hr.innerHTML='<div class="label small">Inst</div>'; for(let i=0;i<STEPS;i++){ const el=document.createElement('div'); el.className='pad ghost'; el.style.height='28px'; el.style.display='flex'; el.style.alignItems='center'; el.style.justifyContent='center'; el.style.fontSize='12px'; el.textContent = (i+1); hr.appendChild(el); } gridHeader.appendChild(hr); gridRows.innerHTML=''; INSTR.forEach(inst=>{ const row=document.createElement('div'); row.className='row'; const lab=document.createElement('div'); lab.className='label'; lab.textContent=inst.label; row.appendChild(lab); for(let i=0;i<STEPS;i++){ const p=document.createElement('div'); p.className='pad '+(seq[inst.id][i]?'active':'ghost'); p.dataset.inst=inst.id; p.dataset.i=i; p.innerHTML = seq[inst.id][i] ? '‚óè' : ''; p.addEventListener('click',()=>{ seq[inst.id][i] = !seq[inst.id][i]; p.classList.toggle('active',seq[inst.id][i]); p.classList.toggle('ghost',!seq[inst.id][i]); p.innerHTML = seq[inst.id][i] ? '‚óè' : ''; renderNotation(); pushState(); }); row.appendChild(p); } gridRows.appendChild(row); }); }
buildGrid();

/* notation */
const canvas = notation; const ctx = canvas.getContext('2d'); function resize(){ canvas.width = canvas.clientWidth * devicePixelRatio; canvas.height = canvas.clientHeight * devicePixelRatio; ctx.setTransform(1,0,0,1,0,0); ctx.scale(devicePixelRatio,devicePixelRatio); drawStaff(); }
window.addEventListener('resize',resize); window.addEventListener('load',resize);
function drawStaff(){ const w=canvas.clientWidth,h=canvas.clientHeight; ctx.clearRect(0,0,w,h); ctx.strokeStyle='#444'; ctx.lineWidth=1; const margin=12; const usable=h-margin*2; const spacing=usable/6; for(let i=0;i<5;i++){ const y=margin+spacing*(i+1); ctx.beginPath(); ctx.moveTo(10,y); ctx.lineTo(w-10,y); ctx.stroke(); } renderNotation(); }
function renderNotation(playhead=-1){ const w=canvas.clientWidth,h=canvas.clientHeight; ctx.clearRect(0,0,w,h); drawStaffLinesOnly(); const left=18,right=w-18,wid=right-left; const stepW=wid/STEPS; const margin=12; const slot=(h-margin*2)/6; const lines=[]; for(let i=1;i<=5;i++) lines.push(margin+slot*i); const spaces=[]; for(let i=0;i<4;i++) spaces.push((lines[i]+lines[i+1])/2); const pos = { kick: spaces[0], floor: spaces[1], snare: spaces[2], tom1: spaces[3], tom2: lines[3], hihat: lines[4] };
  // ghost
  INSTR.forEach(inst=>{ for(let i=0;i<STEPS;i++){ const x=left + i*stepW + stepW/2; const y=pos[inst.id]; ctx.beginPath(); ctx.fillStyle='rgba(255,255,255,0.03)'; ctx.arc(x,y,5,0,Math.PI*2); ctx.fill(); } });
  // active
  INSTR.forEach(inst=>{ for(let i=0;i<STEPS;i++){ if(seq[inst.id][i]){ const x=left + i*stepW + stepW/2; const y=pos[inst.id]; if(inst.id==='hihat'){ ctx.beginPath(); ctx.strokeStyle='#81d4fa'; ctx.lineWidth=2; ctx.moveTo(x-6,y-6); ctx.lineTo(x+6,y+6); ctx.moveTo(x-6,y+6); ctx.lineTo(x+6,y-6); ctx.stroke(); } else { ctx.beginPath(); ctx.fillStyle = (inst.id==='kick'?'#ff8a80': inst.id==='snare'?'#ffd54f':'#ffd180'); ctx.ellipse(x,y,6,4,0,0,Math.PI*2); ctx.fill(); if(['snare','tom1','tom2','floor'].includes(inst.id)){ ctx.beginPath(); ctx.strokeStyle='#ffd54f'; ctx.lineWidth=2; ctx.moveTo(x+4,y); ctx.lineTo(x+4,y-20); ctx.stroke(); } } } } });
  if(playhead>=0){ ctx.beginPath(); ctx.fillStyle='rgba(255,255,255,0.04)'; ctx.fillRect(left+playhead*stepW,6,stepW,h-12); } }
function drawStaffLinesOnly(){ const w=canvas.clientWidth,h=canvas.clientHeight; ctx.save(); ctx.strokeStyle='#444'; ctx.lineWidth=1; const margin=12; const usable=h-margin*2; const spacing=usable/6; for(let i=0;i<5;i++){ const y=margin+spacing*(i+1); ctx.beginPath(); ctx.moveTo(10,y); ctx.lineTo(w-10,y); ctx.stroke(); } ctx.restore(); }

/* simple audio engine (WebAudio) */
const AudioContext = window.AudioContext || window.webkitAudioContext; const audioCtx = new AudioContext(); const master = audioCtx.createGain(); master.gain.value=0.9; master.connect(audioCtx.destination);
function kick(t){ const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type='sine'; o.frequency.setValueAtTime(120,t); o.frequency.exponentialRampToValueAtTime(45,t+0.18); g.gain.setValueAtTime(1,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.35); o.connect(g); g.connect(master); o.start(t); o.stop(t+0.35); }
function snare(t){ const buf=audioCtx.createBuffer(1,audioCtx.sampleRate*0.18,audioCtx.sampleRate); const d=buf.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*Math.exp(-i/d.length*6); const src=audioCtx.createBufferSource(); src.buffer=buf; const f=audioCtx.createBiquadFilter(); f.type='bandpass'; f.frequency.value=2200; const g=audioCtx.createGain(); g.gain.setValueAtTime(1,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.18); src.connect(f); f.connect(g); g.connect(master); src.start(t); src.stop(t+0.18); }
function hihat(t){ const buf=audioCtx.createBuffer(1,audioCtx.sampleRate*0.06,audioCtx.sampleRate); const d=buf.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*Math.exp(-i/d.length*10); const src=audioCtx.createBufferSource(); src.buffer=buf; const f=audioCtx.createBiquadFilter(); f.type='highpass'; f.frequency.value=6000; const g=audioCtx.createGain(); g.gain.setValueAtTime(0.6,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.06); src.connect(f); f.connect(g); g.connect(master); src.start(t); src.stop(t+0.08); }
function tom(t,p){ const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type='sine'; o.frequency.setValueAtTime(p,t); o.frequency.exponentialRampToValueAtTime(p*0.7,t+0.18); g.gain.setValueAtTime(0.9,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.35); o.connect(g); g.connect(master); o.start(t); o.stop(t+0.35); }

/* playback */
let playing=false, idx=0, tickId=null;
function schedule(){ const bpm = parseInt(tempo.value); const ms = (60/bpm)/4*1000; const t=audioCtx.currentTime; INSTR.forEach(inst=>{ if(seq[inst.id][idx]){ if(inst.id==='kick') kick(t); if(inst.id==='snare') snare(t); if(inst.id==='hihat') hihat(t); if(inst.id==='tom1') tom(t,520); if(inst.id==='tom2') tom(t,380); if(inst.id==='floor') tom(t,260); } }); renderNotation(idx); idx=(idx+1)%STEPS; tickId = setTimeout(schedule, ms); }
playBtn.addEventListener('click',()=>{ if(playing) return; playing=true; idx=0; schedule(); }); stopBtn.addEventListener('click',()=>{ if(!playing) return; playing=false; clearTimeout(tickId); renderNotation(-1); }); tempo.addEventListener('input',()=>{ tempoLabel.textContent = tempo.value + ' BPM'; });
clearBtn.addEventListener('click',()=>{ INSTR.forEach(i=>seq[i.id].fill(false)); buildGrid(); renderNotation(); pushState(); });

/* persistence + realtime (minimal) */
async function pushState(){ if(!currentSession) return; const payload = { session_id: currentSession.id, state: JSON.stringify(seq) }; if(supabase){ try{ await supabase.from('sequencer_state').upsert(payload); }catch(e){console.warn(e);} } else { window._localSessions = window._localSessions || {}; if(currentSession) window._localSessions[currentSession.id] = { state: JSON.stringify(seq), created_at: new Date().toISOString() }; } }
function applyState(state){ INSTR.forEach(i=>{ if(state[i.id] && Array.isArray(state[i.id])) seq[i.id] = state[i.id].slice(0,STEPS); }); buildGrid(); renderNotation(); }
let sub=null; function subscribeToSession(id){ if(!supabase) return; try{ if(sub && sub.unsubscribe) sub.unsubscribe(); }catch(e){} sub = supabase.channel('seq-'+id).on('postgres_changes',{event:'*',schema:'public',table:'sequencer_state',filter:`session_id=eq.${id}`}, payload=>{ try{ const row = payload.new || payload.record; if(row && row.state) applyState(JSON.parse(row.state)); }catch(e){console.warn(e);} }).subscribe(); }

/* small helpers */
copyBtn.addEventListener('click',()=>{ if(!currentSession) return alert('No session'); navigator.clipboard.writeText(currentSession.link||''); alert('Link copied'); });
recordBtn.addEventListener('click',()=>{ alert('Recording (local) toggled ‚Äî use Record implementation to capture audio)'); });

// responsive bottom nav show
function refresh(){ if(window.innerWidth<=720) document.getElementById('bottomNav').style.display='flex'; else document.getElementById('bottomNav').style.display='none'; }
window.addEventListener('resize',refresh); refresh();

// initialize
buildGrid(); resize(); renderNotation();
</script>
</body>
</html>
